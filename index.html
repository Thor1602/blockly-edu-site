<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockly by Mr. Thorben</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
          integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.5.1/gsap.min.js"></script>
    <script src="https://unpkg.com/blockly/blockly_compressed.js"></script>
    <script src="https://unpkg.com/blockly/blocks_compressed.js"></script>
    <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
    <script src="https://unpkg.com/blockly/msg/en.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.1.3/pixi.min.js"></script>
    <script src="https://w.soundcloud.com/player/api.js"></script> <!-- Load SoundCloud API -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; /* Hidden initially */
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        body {
            overflow: hidden;
            padding: 0;
        }

        body, html {
            height: 100%;
            margin: 0;
        }

        .right-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .right-content .row {
            width: 100%;
        }

        /* ... (other styles) ... */
        .flex-container {
            display: flex;
            height: 100vh;
        }

        .flex-item-left { /* New class for the left item */
            flex: 0 0 33%; /* Takes 33% of the width */
        }

        .flex-item-right { /* New class for the right item */
            flex: 0 0 66%; /* Takes 66% of the width */
        }

        .btn-primary {
            background-color: #FF9800 !important;
            color: white !important;
            border-color: #FF9800 !important;
        }

        .btn-primary:hover,
        .btn-primary:visited,
        .btn-primary:active,
        .btn-primary:focus {
            background-color: #FF9800 !important;
            color: white !important;
            border-color: #FF9800 !important;
            box-shadow: none !important; /* Remove Bootstrap focus shadow */
        }

        .btn-primary:hover {
            box-shadow: 0 0 10px black !important; /* Adds black glow effect */
        }

        .btn-warning {
            background-color: #f44336 !important; /* Bright red or deep orange */
            color: white !important;
            border-color: #f44336 !important;
        }

        .btn-warning:hover,
        .btn-warning:visited,
        .btn-warning:active,
        .btn-warning:focus {
            background-color: #d32f2f !important;
            color: white !important;
            border-color: #d32f2f !important;
            box-shadow: none !important;
        }

        .btn-warning:hover {
            box-shadow: 0 0 10px red !important;
        }

        .fa-2xl {
            padding: 14px;
        }


        .btn-reset {
            background-color: #7200c3 !important;
            color: white !important;
            border-color: #7200c3 !important;
            display: none;
        }

        .btn-reset:hover,
        .btn-reset:visited,
        .btn-reset:active,
        .btn-reset:focus {
            background-color: #7200c3 !important;
            color: white !important;
            border-color: #7200c3 !important;
            box-shadow: none !important; /* Remove Bootstrap focus shadow */
        }

        .btn-reset:hover {
            box-shadow: 0 0 10px black !important; /* Adds black glow effect */
        }

        .pre-hint-container {
            margin-top: 10px;
            height: 25px;
        }

        .progress-container {
            padding-left: 3px;
            padding-right: 3px;
            margin-left: 3px;
            margin-right: 10px;
            padding-top: 2px;
            height: 25px;
            background-color: white;
            border-radius: 20px;
        }

        .hint-container {
            margin-left: 20px;
            height: 25px;
            background-color: white;
            color: black;
            padding-left: 20px;
            padding-right: 20px;
            border-radius: 20px;
        }

        /* styling for nav bar START */
        .offcanvas {
            position: fixed;
            top: 0;
            left: -250px; /* Initially hidden */
            width: 250px;
            height: 100%;
            background-color: #886500; /* yellow theme */
            color: white;
            overflow-y: auto;
            transition: 0.3s ease-in-out;
            padding-top: 60px;
            z-index: 1050; /* Above everything */
        }

        .offcanvas.show {
            left: 0; /* Slide in */
        }

        .offcanvas a {
            color: white;
            padding: 10px;
            display: block;
            text-decoration: none;
        }

        .offcanvas a:hover {
            background-color: #8c6c0d; /* yellow theme */
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
        }

        /* Dark overlay when menu opens */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1045; /* Just below the sidebar */
            display: none; /* Hidden by default */
        }

        .overlay.show {
            display: block; /* Show when menu opens */
        }

        /* Navbar */
        .navbar {
            position: relative; /* No overlapping */
            z-index: 1030; /* Lower than sidebar */
        }

        /* Content */
        .content {
            padding: 20px;
        }

        .active-bg-sidebar {
            background-color: #8c6c0d; /* yellow theme */
        }

        .bg-sidebar {
            background-color: #886500; /* yellow theme */
        }

        /* styling for nav bar END */

        .grade-card {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            transition: transform 0.2s ease-in-out;
        }

        .grade-card:hover {
            transform: translateY(-5px);
        }

        .grade-title {
            background: linear-gradient(135deg, #ff9800, #fbbb60);
            color: white;
            padding: 0.4rem;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .section-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.3rem;
            color: #333;
        }

        .exercise-link {
            text-decoration: none;
            color: #4e54c8;
            font-weight: 500;
            display: inline-block;
            transition: transform 0.2s, color 0.2s;
        }

        .exercise-link:hover {
            color: #2d2d94;
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .row-cols-lg-6 > * {
                flex: 0 0 50%;
                max-width: 50%;
            }
        }

    </style>

</head>
<body onload="loadUser()">

<nav class="navbar navbar-dark bg-warning">
    <div class="container-fluid">
        <!-- Hamburger Button -->
        <button class="navbar-toggler" type="button" onclick="toggleMenu()">
            <span class="navbar-toggler-icon"></span>
        </button>
        <select class="form-select form-select-lg mb-3" aria-label=".form-select-lg example" id="visualisationSize">
            <option selected disabled>Game Size</option>
            <option value="Extra Small">Extra Small</option>
            <option value="Small">Small</option>
            <option value="Medium">Medium</option>
            <option value="Large">Large</option>
            <option value="Extra Large">Extra Large</option>
        </select>
        <a href="#" class="navbar-brand ml-3" onclick="event.preventDefault(); showPane('home')">
            Seoul Academy Apgujeong
        </a>
        <a class="nav-link disabled" id="activeUserEmail"></a>
        <img src="https://i.postimg.cc/qMKT5SS9/logo.png" height="40px" width="40px" alt=""/>

    </div>
</nav>


<!-- Dark Overlay (Shades Background) -->
<div id="overlay" class="overlay" onclick="toggleMenu()"></div>

<!-- OffCanvas Sidebar Menu -->
<div id="sidebar" class="offcanvas">
    <span class="close-btn" onclick="toggleMenu()">&times;</span>
    <ul class="nav flex-column" id="sidebarMenu">
        <!-- Grades with Submenus -->
        <li class="nav-item"><h3 class="activeUserName"></h3></li>
        <li class="nav-item">
            <a href="#" class="nav-link" data-parent="#sidebarMenu" onclick="event.preventDefault(); showPane('home')">HOME</a>
        </li>
        <li class="nav-item">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="collapse" data-target="#kinderMenu"
               data-parent="#sidebarMenu">Kinder</a>
            <div id="kinderMenu" class="collapse">
                <a href="#" class="nav-link pl-4">Sequencing</a>
            </div>
        </li>
        <li class="nav-item">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="collapse" data-target="#grade1Menu"
               data-parent="#sidebarMenu">Grade 1</a>
            <div id="grade1Menu" class="collapse">
                <a href="#" class="nav-link pl-4">Sequencing</a>
            </div>
        </li>
        <li class="nav-item">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="collapse" data-target="#grade2Menu"
               data-parent="#sidebarMenu">Grade 2</a>
            <div id="grade2Menu" class="collapse">
                <a href="#" class="nav-link pl-4">Sequencing</a>
                <div class="pl-5">
                    <a href="#taxiDriverSequencing2" class="nav-link">Mr. Cab Driver</a>
                </div>
            </div>
        </li>
        <li class="nav-item">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="collapse" data-target="#grade3Menu"
               data-parent="#sidebarMenu">Grade 3</a>
            <div id="grade3Menu" class="collapse">
                <a href="#" class="nav-link pl-4">Sequencing</a>
                <div class="pl-5">
                    <a href="#taxiDriverSequencing3" class="nav-link">Mr. Cab Driver</a>
                </div>
            </div>
        </li>
        <li class="nav-item">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="collapse" data-target="#grade4Menu"
               data-parent="#sidebarMenu">Grade 4</a>
            <div id="grade4Menu" class="collapse">
                <a href="#" class="nav-link pl-4">Sequencing</a>
            </div>
        </li>
        <li class="nav-item">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="collapse" data-target="#grade5Menu"
               data-parent="#sidebarMenu">Grade 5</a>
            <div id="grade5Menu" class="collapse">
                <a href="#" class="nav-link pl-4">Sequencing</a>
            </div>
        </li>
    </ul>
</div>

<div id="home" class="tab-pane active">
    <button class="btn btn-lg btn-primary" onclick="showPane('codingPane')">Continue</button>
    <div class="container">
        <h1 class="text-center mb-5 fw-bold">âœ¨ Coding Activities âœ¨</h1>
        <h3 class="text-center mb-5 fw-bold activeUserName"></h3>
        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-3 g-4">
            <div class="col">
                <div class="grade-card h-100">
                    <div class="grade-title">Grade K</div>
                    <div>
                        <div class="section-title">Sequencing</div>
                        <a href="#" class="exercise-link" onclick="setNextLevel('taxi_driver_k')">Mr. Cab Driver</a>
                    </div>
                    <div>
                        <div class="section-title">Loops</div>
                        <a>Coming soon</a>
                    </div>
                    <div>
                        <div class="section-title">Events</div>
                        <a>Coming soon</a>
                    </div>
                </div>
            </div>

            <div class="col">
                <div class="grade-card h-100">
                    <div class="grade-title">Grade 1</div>
                    <div>
                        <div class="section-title">Sequencing</div>
                        <a href="#" class="exercise-link" onclick="setNextLevel('taxi_driver_1')">Mr. Cab Driver</a>
                    </div>
                    <div>
                        <div class="section-title">Loops</div>
                        <a>Coming soon</a>
                    </div>
                    <div>
                        <div class="section-title">Events</div>
                        <a>Coming soon</a>
                    </div>
                </div>
            </div>

            <div class="col">
                <div class="grade-card h-100">
                    <div class="grade-title">Grade 2</div>
                    <div>
                        <div class="section-title">Sequencing</div>
                        <a href="#" class="exercise-link" onclick="setNextLevel('taxi_pickup_one')">Mr. Cab Driver</a>
                    </div>
                    <div>
                        <div class="section-title">Loops</div>
                        <a>Coming soon</a>
                    </div>
                    <div>
                        <div class="section-title">Events</div>
                        <a>Coming soon</a>
                    </div>
                </div>
            </div>

            <div class="col">
                <div class="grade-card h-100">
                    <div class="grade-title">Grade 3</div>
                    <div>
                        <div class="section-title">Sequencing</div>
                        <a href="#" class="exercise-link" onclick="setNextLevel('taxi_driver_3')">Mr. Cab Driver</a>
                    </div>
                    <div>
                        <div class="section-title">Loops</div>
                        <a>Coming soon</a>
                    </div>
                    <div>
                        <div class="section-title">Events</div>
                        <a>Coming soon</a>
                    </div>
                </div>
            </div>

            <div class="col">
                <div class="grade-card h-100">
                    <div class="grade-title">Grade 4</div>
                    <div>
                        <div class="section-title">Sequencing</div>
                        <a href="#" class="exercise-link" onclick="setNextLevel('taxi_driver_4')">Mr. Cab Driver</a>
                    </div>
                    <div>
                        <div class="section-title">Loops</div>
                        <a>Coming soon</a>
                    </div>
                    <div>
                        <div class="section-title">Events</div>
                        <a>Coming soon</a>
                    </div>
                </div>
            </div>

            <div class="col">
                <div class="grade-card h-100">
                    <div class="grade-title">Grade 5</div>
                    <div>
                        <div class="section-title">Sequencing</div>
                        <a href="#" class="exercise-link" onclick="setNextLevel('taxi_driver_5')">Mr. Cab Driver</a>
                    </div>
                    <div>
                        <div class="section-title">Loops</div>
                        <a>Coming soon</a>
                    </div>
                    <div>
                        <div class="section-title">Events</div>
                        <a>Coming soon</a>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
<div id="codingPane" class="tab-pane">
    <div class="container-fluid vh-100 d-flex flex-row content">
        <!-- Left Side (Visualization) -->
        <div class="d-flex flex-column overflow-auto">
            <div id="visualisation" class="border rounded bg-light p-2"></div>

            <div class="mt-3 d-flex justify-content-between">
                <button class="btn btn-lg btn-primary" id="btnRun">
                    <i class="fa-solid fa-play"></i> RUN
                </button>
                <button class="btn btn-lg btn-reset" id="btnReset">
                    <i class="fa-solid fa-rotate-right"></i> RESET
                </button>
                <button class="btn btn-lg btn-primary" id="btnStep">
                    <i class="fa-solid fa-forward-step"></i> STEP
                </button>
            </div>
            <label for="speed" class="form-label"></label>
            <input type="range" class="form-range" min="0" max="10" step="1" id="speed" style="display: none">

        </div>

        <div class="d-flex flex-column flex-grow-1 mx-3">
            <div class="bg-warning p-3 ml-5 sticky-top">

                <!-- EVERYTHING IN ONE HORIZONTAL LINE -->
                <div class="d-flex align-items-center gap-3 flex-wrap">
                    <!-- Dot Progress Bar -->
                    <div class="d-flex justify-content-center progress-container" style="gap: 10px;">
                        <div class="rounded-circle bg-success" style="width: 20px; height: 20px;"></div>
                        <div class="rounded-circle bg-dark" style="width: 20px; height: 20px;"></div>
                        <div class="rounded-circle bg-secondary" style="width: 20px; height: 20px;"></div>
                        <div class="rounded-circle bg-secondary" style="width: 20px; height: 20px;"></div>
                    </div>

                    <!-- Button Group -->
                    <div class="d-flex gap-2 flex-wrap">


                        <button class="btn btn-lg btn-primary" id="blocksLeftover" data-bs-toggle="tooltip"
                                data-bs-placement="top" title="See here the blocks you have left.">
                            <span id="numberBlockCapacity"></span> block(s)
                            <span id="contentBlockCapacity"></span>
                        </button>
                        <button class="btn btn-lg btn-primary" id="nextLevel" tabindex="0" data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="Click here to go to the next level when the level completed" disabled>
                            <i class="fa-solid fa-right-long fa-2xl"></i>
                        </button>

                        <button class="btn btn-lg btn-primary" data-toggle="modal" data-target="#omgTeacherModal"
                                data-bs-toggle="tooltip" data-bs-placement="top"
                                title="OMG Mr.Thorben!! I found an error and you should fix it!!">
                            <i class="fa-solid fa-bug fa-2xl"></i>
                        </button>

                        <button class="btn btn-lg btn-primary" data-toggle="modal" data-target="#instructionsModal"
                                data-bs-toggle="tooltip" data-bs-placement="top" title="Click here for instructions">
                            <i class="fa-solid fa-person-chalkboard fa-2xl"></i>
                        </button>

                        <button class="btn btn-lg btn-primary" data-toggle="modal" data-target="#hintModal" tabindex="0"
                                data-bs-toggle="tooltip" data-bs-placement="top"
                                title="Click here for a hint if enabled" disabled>
                            <i class="fa-solid fa-question fa-2xl"></i>
                        </button>


                    </div>

                </div>

                <!-- Live Feedback Container -->
                <div class="d-flex align-items-center mt-2">
                    <div class="pre-hint-container" id="liveFeedback"></div>
                </div>

            </div>

            <div class="border rounded bg-white p-2 flex-grow-1">
                <div id="blocklyDiv" style="height: 90%; width: 100%;"></div>
            </div>
        </div>
    </div>
</div>
<!-- Warning Modal -->
<div class="modal fade" id="warningModal" tabindex="-1" role="dialog" aria-labelledby="warningModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="warningModalLabel">Warning</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                This level is in development.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="omgTeacherModal" tabindex="-1" role="dialog" aria-labelledby="omgTeacherModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content modal-dialog-centered">
            <div class="modal-header">
                <h5 class="modal-title" id="omgTeacherModalLabel">The "I found a bug" report</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="bugContent">Describe the bug and where it happened</label>
                        <textarea class="form-control" id="bugContent" name="bugDescription" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="sendBtnBugForm">Send to Mr. Thorben</button>
                </div>
            </form>

        </div>
    </div>
</div>

<div class="modal fade" id="instructionsModal" tabindex="-1" role="dialog" aria-labelledby="instructionsModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="instructionsModalLabel">Instructions</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="instructionsContent">
                No instructions
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="hintModal" tabindex="-1" role="dialog" aria-labelledby="hintModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="hintModalLabel">Hint</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="hintContent">
                No hints
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="nextLevelModal" tabindex="-1" role="dialog" aria-labelledby="nextLevelModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="nextLevelModalLabel">CONGRATULATIONS</h3>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="feedback">

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="retryBeforeNextLevel" data-dismiss="modal">Retry
                </button>
                <button type="button" class="btn btn-lg btn-primary" id="nextLevelModalBtn">Continue</button>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

<script>
    // TODO getPerson sometimes gets the last person wrong. Change it by the len of a list where sprites.hide are skipped
    // TODO change grid size 12 and 16 to the size length of the map
    // TODO taxi can get people sometimes. It can get people from the hood side but not here in the second loop taxi_pickup_five
    // TODO add code in case there is no user logged in,
    let email = null;
    let firstname = null;
    let lastname = null;
    let studentId = null;
    let className = null;
    let grade = null;

    function loadUser() {
        console.log("loadUser() called"); // Step 1
        try {
            google.script.run
                .withSuccessHandler(function (studentData) {
                    email = studentData[0];
                    firstname = studentData[1];
                    lastname = studentData[2];
                    studentId = studentData[3];
                    className = studentData[4];
                    grade = studentData[5];
                    document.getElementById("activeUserEmail").innerText = email;
                    document.querySelectorAll(".activeUserName").forEach(el => {
                        el.innerText = "ðŸ’› Hi " + firstname + " " + lastname + " (" + className + ") ðŸ’›";
                    });
                })
                .withFailureHandler(function (error) {
                    console.error("Failed to get user email:", error.message || error);
                    document.getElementById("activeUserEmail").innerText = "Please login with your Google account!";
                })
                .getStudentData();
        } catch (e) {
            document.getElementById("activeUserEmail").innerText = "Login failed, Mr. Thorben must fix this.";
        }
    }

    window.onload = function () {
        loadUser();
    }

    let configData = null; // Global variable to store JSON
    async function fetchData() {
        // const response = await fetch('https://raw.githubusercontent.com/Thor1602/blockly-edu-site/main/blocks.json');
        const response = await fetch('blocks.json');
        configData = await response.json();
    }


    buttonSpeedElement = document.getElementById('speed');
    buttonRunElement = document.getElementById("btnRun");
    buttonResetElement = document.getElementById("btnReset");
    buttonStepElement = document.getElementById("btnStep");
    // maxBlocks
    numberBlockCapacityElement = document.getElementById("numberBlockCapacity");
    contentBlockCapacityElement = document.getElementById("contentBlockCapacity");
    buttonCapacityElement = document.getElementById("blocksLeftover");

    buttonVisualisationElement = document.getElementById("visualisation");
    buttonLiveFeedbackElement = document.getElementById("liveFeedback");
    buttonHintModalElement = document.getElementById("hintModal");
    buttonNextLevelElement = document.getElementById("nextLevel");
    buttonNextLevelModalElement = document.getElementById("nextLevelModalBtn");
    buttonInstructionsModalElement = document.getElementById("instructionsModal");
    buttonSendBugFormElement = document.getElementById("sendBtnBugForm");

    retryBeforeNextLevelElement = document.getElementById("retryBeforeNextLevel");
    feedbackElement = document.getElementById("feedback");
    hintContentElement = document.getElementById("hintContent");
    instructionsContentElement = document.getElementById("instructionsContent");

    blocklyDivElement = document.getElementById('blocklyDiv');
    visualisationSize = document.getElementById("visualisationSize");
    $nextLevelModal = $("#nextLevelModal");
    $omgTeacherModal = $("#omgTeacherModal");

    class Activity {
        static allActivities = [];

        constructor(name) {
            this.name = name;
            this.type = null;
            this.level = null;
            this.maxBlocks = null;
            this.playerInfo = null;
            this.movable_sprites = null;
            this.mapLayout = null;
            this.instructions = null;
            this.feedback = null;
            this.hints = null;
            this.sprites = [];  // Initialize as empty arrays
            this.people = [];   // Initialize as empty arrays
            this.sounds = null;
            this.player = null;
            this.blocks = null;
            this.blockManager = null;
            this.goal = null;
            this.positions = null;
            this.startedOn = new Date().toISOString();
            this.map = null; // Initialize as null and set it later asynchronously
            this.app = null; // Initialize as null
            this._gridSize = null;
            this.rowLength = null;
            this.colLength = null;
            this.speed = 1;
            this.speedElement = buttonSpeedElement;
            this.isRunning = false;
            this.isComplete = false;


            this.overlayContainer = null;
            buttonRunElement.addEventListener("click", () => {
                this.runCode();
            });
            buttonResetElement.addEventListener("click", () => {
                this.resetCode();
            });
            retryBeforeNextLevelElement.addEventListener("click", () => {
                this.resetCode();
            });
            this.init();

        }

        async init() {
            await this.getExercise();
            await this.initializeActivity();
            await this.initializeBlocklyWorkspace();
            this.addKeyInput(this.runCode, this.resetCode);
            this.visualisationDivSizeListener();
        }

        async getExercise() {
            if (!configData) {
                await fetchData();
            }
            console.log(this.name);
            const exercise = configData.exercises.find(exercise => exercise.name === this.name);
            this.type = exercise.type;
            this.level = exercise.level;
            this.maxBlocks = exercise.maxBlocks;
            this.playerInfo = exercise.playerInfo;
            this.movable_sprites = exercise.movable_sprites;
            this.instructions = exercise.instructions;
            this.feedback = exercise.feedback;
            if (localStorage.getItem('visualisationSize') !== null) {
                this._gridSize = localStorage.getItem('visualisationSize');
            } else {
                this._gridSize = exercise.gridSize;
            }
            this.rowLength = exercise.rowLength;
            this.colLength = exercise.colLength;
            this.hints = exercise.hints;
            this.mapLayout = exercise.mapLayout;
            this.sounds = exercise.sounds;
            this.blocks = exercise.blocks;
            this.goal = exercise.goal;
            this.positions = exercise.positions;
            feedbackElement.innerHTML = this.instructions;
            instructionsContentElement.innerHTML = this.instructions;
            hintContentElement.innerHTML = this.hints;

        }

        async levelCompleted() {
            Activity.playSound("https://raw.githubusercontent.com/Thor1602/blockly-edu-site/main/audio/level-up-enhancement-8-bit-retro-sound-effect-153002.mp3");
            this.hasSucceededOverlay();
            this.isComplete = true;
            buttonNextLevelElement.disabled = false;
            $nextLevelModal.modal({
                backdrop: 'static',
                keyboard: false,
                show: true
            });
            console.log("Level Finished");
        }

        async initializeActivity() {
            if (this.speed) {
                this.speedElement.style.display = "inline-block";
                this.speed = this.speedElement.value;
                this.speedElement.oninput = () => this.speed = this.speedElement.value;
            }

            this.app = new PIXI.Application({
                width: this.rowLength * this._gridSize, // Default placeholder values
                height: this.colLength * this._gridSize, // Default placeholder values
                backgroundColor: 0xAAAAAA
            });

            // Initialize the map first
            this.map = await new MapLayout(this.mapLayout, false, this.app);
            await this.map.initialize(this.mapLayout);
            this.player = new Player(this.playerInfo.image, this.playerInfo.row, this.playerInfo.col, this.playerInfo.setNotification, this.playerInfo.notification, this._gridSize, this.app, this);

            for (let pos of this.positions) {
                this.sprites.push(new Sprite('https://i.postimg.cc/wvRBMQZ5/person.png', pos[0], pos[1], true, pos[2], this._gridSize, this.app, this));
            }
            this.people = Sprite.listOfSprites.filter(item => !(item instanceof Player));
            this.sprites = Sprite.listOfSprites;
            // Append PIXI app view (canvas) to DOM
            buttonVisualisationElement.appendChild(this.app.view);

            this.initializeEnvironment();
            this.map.drawSprites(this.sprites);  // Pass the correct 'sprites' array
        }

        initializeEnvironment() {
            if (!this.map) {
                console.error("Map is not initialized yet.");
                return;
            }

            if (this.sprites) {
                this.sprites.forEach((sprite) => {
                    if (sprite) sprite.resize(this._gridSize);
                });
            }
            this.map.drawMap(this._gridSize);
        }

        visualisationDivSizeListener() {
            visualisationSize.addEventListener("change", () => {
                if (visualisationSize.value === "Medium") {
                    this.resizeActivity(30);
                    localStorage.setItem('visualisationSize', 30);
                } else if (visualisationSize.value === "Large") {
                    this.resizeActivity(40);
                    localStorage.setItem('visualisationSize', 40);
                } else if (visualisationSize.value === "Small") {
                    this.resizeActivity(25);
                    localStorage.setItem('visualisationSize', 25);
                } else if (visualisationSize.value === "Extra Small") {
                    this.resizeActivity(20);
                    localStorage.setItem('visualisationSize', 20);
                } else if (visualisationSize.value === "Extra Large") {
                    this.resizeActivity(45);
                    localStorage.setItem('visualisationSize', 45);
                } else {
                    this.resizeActivity(30);
                    localStorage.setItem('visualisationSize', 30);
                }
            });
        }

        resizeActivity(newGridSize) {
            this._gridSize = newGridSize;

            // Resize all sprites (including player)
            if (this.sprites) {
                this.sprites.forEach(sprite => {
                    if (sprite) sprite.resize(newGridSize);
                });
            }

            // Resize player separately if needed
            if (this.player) {
                this.player.resize(newGridSize);
            }

            // Resize map (if you make a resize method in MapLayout)
            if (this.map) {
                this.map.drawMap(newGridSize);  // it uses internal gridSize
                this.map.drawSprites(this.sprites);
            }

            // Resize PIXI app view/canvas
            if (this.app) {
                this.app.renderer.resize(12 * newGridSize, 16 * newGridSize);
            }
        }

        hasSucceededOverlay() {
            this.addOverlay("Challenge\nCompleted!", 0x000000);
        }

        hasFailed() {
            this.addOverlay("ðŸ¤”", 0x000000);
        }

        addOverlay(message, color) {
            if (!this.app || this.overlayContainer) return;
            this.isRunning = false;
            // Create container for overlay elements
            this.overlayContainer = new PIXI.Container();
            // 1. Semi-transparent black rectangle
            const overlay = new PIXI.Graphics();
            overlay.beginFill(color, 0.3); // 30% black
            overlay.drawRect(0, 0, this.app.screen.width, this.app.screen.height);
            overlay.endFill();
            this.overlayContainer.addChild(overlay);
            // 2. Centered "Try Again" text
            const textMessage = new PIXI.Text(message, {
                fontFamily: "Arial",
                fontSize: 48,
                fill: 0xffffff,
                align: "center"
            });
            textMessage.anchor.set(0.5);
            textMessage.x = this.app.screen.width / 2;
            textMessage.y = this.app.screen.height / 2;
            this.overlayContainer.addChild(textMessage);

            // Optional: Make overlay block interactions below
            this.overlayContainer.interactive = true;
            this.overlayContainer.interactiveChildren = false;

            // Add overlay to stage
            this.app.stage.addChild(this.overlayContainer);
        }

        removeOverlay() {
            if (this.overlayContainer) {
                this.app.stage.removeChild(this.overlayContainer);
                this.overlayContainer.destroy({children: true});
                this.overlayContainer = null;
            }
        }


        resetActivity() {
            if (this.app) {
                this.app.destroy(true, {children: true});
                this.app = null;
            }

            // Reset everything
            this.player = null;
            this.people = [];
            this.sprites = [];
            this.mapLayout = null;


            // Also clear the canvas container (if reused)
            buttonVisualisationElement.innerHTML = "";
        }


        // what my sprites will do according to the blocks
        pick_up() {
            return new Promise(resolve => this.player.getPerson(this, this.people, this.speed, resolve));
        }

        move_north() {
            return new Promise(resolve => this.player.moveBy(0, -1, this.getMapLayout(), this.speed, this.isRunning, resolve));
        }

        move_south() {
            return new Promise(resolve => this.player.moveBy(0, 1, this.getMapLayout(), this.speed, this.isRunning, resolve));
        }

        move_west() {
            return new Promise(resolve => this.player.moveBy(-1, 0, this.getMapLayout(), this.speed, this.isRunning, resolve));
        }

        move_east() {
            return new Promise(resolve => this.player.moveBy(1, 0, this.getMapLayout(), this.speed, this.isRunning, resolve));
        }

        runCodeBlock() {
            return new Promise(resolve => {
                this.giveHint("The code has started RUNNING", "3000");
                resolve(); // Resolve immediately after showing the hint
            });
        }


        // Running Blockly Code
        async runCode() {
            if (this.isRunning) return; // Prevent multiple executions
            this.isRunning = true;
            this.player.initialize();
            buttonRunElement.style.display = "none";
            buttonResetElement.style.display = "inline-block";
            let runEventBlock = this.blockManager.workspace.getAllBlocks().find(block => block.type === 'run_event');
            if (!runEventBlock) {
                this.giveHint("Error: Run block is missing. Please add the Run block.", "15000");
                this.hasFailed();
                this.isRunning = false; // Allow execution again
                return;
            }
            javascript.javascriptGenerator.init(this.blockManager.workspace);
            let code = javascript.javascriptGenerator.blockToCode(runEventBlock);
            try {
                await eval(`(async () => {
                    let checkRunning = () => this.isRunning; // Closure to check the flag
                    ${code.split("await").join("if (!checkRunning()) return; await")} // Insert check before each await
                })();`);
            } catch (error) {
                console.error("Error executing code:", error);
            } finally {
                this.isRunning = false;
            }

            try {
                const xmlDom = Blockly.Xml.workspaceToDom(this.blockManager.workspace);
                const xmlText = Blockly.Xml.domToText(xmlDom);
                const blockExcess = numberBlockCapacityElement.innerText === "over";
                const blocksOver = blockExcess ? parseInt(numberBlockCapacityElement.innerText) : 0;
                google.script.run
                    .withSuccessHandler(function (nextLevel) {
                        console.log("Progress submitted successfully.");
                        console.log("Next level is: " + nextLevel);
                        // Store the next level in localStorage or sessionStorage (optional)
                        sessionStorage.setItem("nextLevel", nextLevel);
                        console.log(sessionStorage.getItem("nextLevel"));
                        // Reload the page
                        window.location.reload();  // This will reload the page
                    })
                    .withFailureHandler(function (error) {
                        console.error("Error submitting progress:", error);

                    })
                    .insertProgress({
                        email: email,
                        className: className,
                        grade: grade,
                        studentId: studentId,
                        level: this.name,
                        workspaceXml: xmlText,
                        feedback: "Solid work!",
                        startedOn: this.startedOn,
                        blockExcess: blockExcess,
                        blocksOver: blocksOver,
                        isCompleted: this.isComplete
                    });

            } catch (e) {
                console.error("Unexpected error in script.run:", e);
            }
        }


        resetCode() {
            this.isRunning = false;
            this.removeOverlay();
            // this.getMap().setGridSize();
            // this.initializeEnvironment();
            buttonResetElement.disabled = true;
            buttonStepElement.disabled = true;
            buttonRunElement.disabled = true;
            buttonResetElement.innerHTML = `
                    <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
                    LOAD
                `;
            buttonStepElement.innerHTML = `
                    <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
                    LOAD
                `;
            setTimeout(() => {
                // Draw the sprites (including the new player)
                this.map.drawSprites(this.sprites);
                Sprite.restoreNotifactionNumberForAllSprites();
                // Initialize the new player (taxi)
                this.player.initialize();
                // Reset other elements (e.g., people notifications)
                this.people.forEach(sprite => sprite.notify(sprite.original_notif_number));
                this.people.forEach(sprite => sprite.show());
            }, 800); //  delay
            setTimeout(() => {
                buttonResetElement.innerHTML = `<i class="fa-solid fa-rotate-right"></i> RESET`;
                buttonStepElement.innerHTML = `<i class="fa-solid fa-forward-step"></i> STEP`;
                buttonResetElement.disabled = false;
                buttonStepElement.disabled = false;
                buttonRunElement.disabled = false;
                buttonRunElement.style.display = "inline-block"; // Show RUN button
                buttonResetElement.style.display = "none"; // Hide RESET button
            }, 900); //  delay
        }

        getMapLayout() {
            return this.map.mapLayout;
        }

        async initializeBlocklyWorkspace() {
            if (!configData) {
                await fetchData();
            }
            this.blockManager = new BlockManager(blocklyDivElement, this.maxBlocks);
            this.blockManager.loadBlocks(this.blocks);
        }


        giveHint(message, time) {
            const hint = buttonLiveFeedbackElement;
            $('#liveFeedback').addClass('hint-container');
            hint.textContent = message;
            setTimeout(() => {
                hint.textContent = "";
                $('#liveFeedback').removeClass('hint-container');
            }, time);

        }


        addKeyInput(runCode, resetCode) {
            document.addEventListener("keydown", function (event) {
                const displayStyle = window.getComputedStyle(buttonRunElement).display; // Get computed display style
                const speedSlider = buttonSpeedElement; // Get the slider element

                if (event.code === "KeyR") {
                    if (displayStyle === "block") {
                        runCode();
                    } else if (displayStyle === "none") {
                        resetCode();
                    }
                } else if (event.code === "KeyS") {
                    alert("S key was pressed!");
                } else if (event.code === "KeyD") {
                    // Increase slider value
                    if (speedSlider) {
                        speedSlider.value = Math.min(parseInt(speedSlider.value) + 1, speedSlider.max);
                    }
                } else if (event.code === "KeyA") {
                    // Decrease slider value
                    if (speedSlider) {
                        speedSlider.value = Math.max(parseInt(speedSlider.value) - 1, speedSlider.min);
                    }
                }

            });
        }

        static playSound(link) {
            const audio = new Audio(link);
            audio.play().catch(err => {
                console.warn("Playback failed:", err);
            });
        }

        static async fetchAllActivities() {
            if (!configData) {
                await fetchData();
            }
            Activity.allActivities = configData.exercises.map(exercise => exercise.name);
        }

    }


    class MapLayout {
        constructor(mapLayoutName, grid, app) {
            this.grid = grid;
            this.app = app;
            this.mapLayout = null;
            // this.mapRows = null;
            // this.mapCols = null;
            this.mapContainer = new PIXI.Container();
            this.app.stage.addChild(this.mapContainer);
        }

        async initialize(mapLayoutName) {
            this.mapLayout = await this.loadMapLayout(mapLayoutName); // Asynchronous operation
            this.mapRows = Object.keys(this.mapLayout).length;
            this.mapCols = Object.keys(this.mapLayout[Object.keys(this.mapLayout)[0]]).length;
        }


        async loadMapLayout(mapLayoutNameParam) {
            try {
                await fetchData();
                const layoutObj = configData.map_layouts.find(layout => layout.name === mapLayoutNameParam);
                return layoutObj ? layoutObj.layout : null;
            } catch (error) {
                console.error("Error fetching JSON:", error);
                return null;
            }
        }

        drawMap(gridSize) {
            this.reset();
            const parkColors = [0x00FF00, 0x228B22, 0x32CD32]; // Different shades of green
            let rowIndex = 0; // Track the numerical row index
            for (const rowKey in this.mapLayout) {
                let colIndex = 0; // Track the numerical column index
                for (const colKey in this.mapLayout[rowKey]) {
                    let tile = new PIXI.Graphics();
                    const tileValue = this.mapLayout[rowKey][colKey];
                    if (this.grid) tile.lineStyle(1, 0x9b9b9b, 1); // (width, color, alpha)
                    const parkColor = parkColors[Math.floor(Math.random() * parkColors.length)];
                    tile.beginFill(tileValue === 1 ? 0xCCCCCC : (tileValue === 2 ? parkColor : 0x555555));
                    tile.drawRect(colIndex * gridSize, rowIndex * gridSize, gridSize, gridSize);
                    tile.endFill();
                    this.mapContainer.addChild(tile);
                    colIndex++;
                }
                rowIndex++;
            }
        }

        drawSprites(listOfSprites) {
            if (listOfSprites) {
                listOfSprites.forEach((sprite) => {
                    if (sprite) this.app.stage.addChild(sprite.container);
                });
            }
        }

        reset() {
            if (this.mapContainer) {
                this.mapContainer.removeChildren();
            }
        }
    }

    class BlockManager {
        constructor(blocklyDiv, maxBlocks) {
            this.blocklyDiv = blocklyDiv;
            this.maxBlocks = maxBlocks;
            this.workspace = null;
            this.customTheme = null;
        }

        loadBlocks(blocks) {
            try {
                const filteredBlocks = blocks
                    .map(type => configData.blocks.find(block => block.type === type))
                    .filter(Boolean);
                this.loadTheme(configData.blocklyThemeSettings);
                this.defineBlocks(filteredBlocks);
                this.createToolbox(filteredBlocks);
                this.injectWorkspace();
                this.setupChangeListener();
                this.setupResizeObserver(); // Add resize listener

            } catch (error) {
                console.error('Error loading Blockly settings:', error);
            }
        }

        loadTheme(themeSettings) {
            if (themeSettings && themeSettings.length > 0) {
                const themeData = themeSettings[0];
                this.customTheme = Blockly.Theme.defineTheme(themeData.themeName, {
                    base: Blockly.Themes[themeData.base] || Blockly.Themes.Classic,
                    fontStyle: themeData.fontStyle,
                    componentStyles: themeData.componentStyles,
                    blockStyles: themeData.blockStyles
                });
            } else {
                console.error('No theme settings found in JSON.');
            }
        }

        defineBlocks(blocks) {
            if (!blocks || blocks.length === 0) {
                throw new Error('No blocks found in JSON.');
            }
            blocks.forEach(block => {
                Blockly.common.defineBlocksWithJsonArray([{...block}]);
                javascript.javascriptGenerator.forBlock[block.type] = () => block.javascript_function;
            });
            javascript.javascriptGenerator.forBlock['controls_repeat_ext'] = function (block) {
                let times = block.getFieldValue('TIMES') || 10; // Get number of repeats
                let innerCode = javascript.javascriptGenerator.statementToCode(block, 'DO'); // Get inner blocks
                let repeatCode = `
                for (let i = 0; i < ${times}; i++) {
                    ${innerCode}
                }
            `;
                return repeatCode; // âœ… Returns JavaScript code instead of calling repeat_10(block);
            };
        }

        createToolbox(blocks) {
            this.toolbox = {
                'kind': 'flyoutToolbox',
                'contents': blocks.map(block => ({'kind': 'block', 'type': block.type}))
            };
        }

        injectWorkspace() {
            this.workspace = Blockly.inject(this.blocklyDiv, {
                toolbox: this.toolbox,
                theme: this.customTheme,
                trashcan: true,
                move: {
                    scrollbars: {
                        horizontal: true,
                        vertical: true
                    },
                    drag: true,
                    wheel: true
                }
            });
        }

        countAttachedBlocks(block) {
            if (!block) return 0;

            let count = 1; // Count this block

            // Go through each input (statement, value, dummy)
            for (const input of block.inputList) {
                const connected = input.connection?.targetBlock();
                if (connected) {
                    count += this.countAttachedBlocks(connected);
                }
            }

            // Also go through the next block in the sequence (outside of inputs)
            const nextBlock = block.getNextBlock();
            if (nextBlock) {
                count += this.countAttachedBlocks(nextBlock);
            }

            return count;
        }


        setupChangeListener() {
            const updateCapacity = () => {
                const allBlocks = this.workspace.getAllBlocks();
                const runEventBlock = allBlocks.find(block => block.type === 'run_event');
                let usedBlocks = 0;
                if (runEventBlock) {
                    usedBlocks = this.countAttachedBlocks(runEventBlock);
                }

                const remaining = this.maxBlocks - usedBlocks;

                numberBlockCapacityElement.textContent = Math.abs(remaining);

                if (remaining < 0) {
                    buttonCapacityElement.classList.remove("btn-primary");
                    buttonCapacityElement.classList.add("btn-warning");
                    contentBlockCapacityElement.textContent = "over";
                } else {
                    buttonCapacityElement.classList.remove("btn-warning");
                    buttonCapacityElement.classList.add("btn-primary");
                    contentBlockCapacityElement.textContent = "left";
                }
            };
            // Initial capacity update
            this.workspace.addChangeListener(updateCapacity);
            updateCapacity(); // initial run
        }


        setupResizeObserver() {
            if (!buttonVisualisationElement) {
                console.error("ResizeObserver error: visualisation element not found.");
                return;
            }

            const resizeObserver = new ResizeObserver(() => {
                this.resizeBlocklyWorkspace();
            });

            resizeObserver.observe(buttonVisualisationElement);
        }

        // Resizes the Blockly workspace
        resizeBlocklyWorkspace() {
            if (this.workspace) {
                Blockly.svgResize(this.workspace);
            }
        }
    }


    class Sprite {
        static listOfSprites = [];
        static #numberOfEnvironmentSprites = 0;

        constructor(imageURL, row, col, showNotif = false, notif_number = 0, gridSize, app, activity) {
            this.row = row;
            this.col = col;
            this._gridSize = gridSize;
            this.showNotif = showNotif;
            this.activity = activity;
            this.notif_number = notif_number;
            this.app = app;
            this.original_notif_number = notif_number;
            this.sprite = PIXI.Sprite.from(imageURL);
            this.sprite.anchor.set(0.5);
            this.updateSizeAndPosition();
            Object.defineProperty(this, "originalRow", {
                value: row,
                writable: false, // Prevent modification
                configurable: false, // Prevent redefinition
            });
            Object.defineProperty(this, "originalCol", {
                value: col,
                writable: false, // Prevent modification
                configurable: false, // Prevent redefinition
            });
            this.container = new PIXI.Container();
            this.container.addChild(this.sprite);

            if (this.showNotif) {
                this.notifText = new PIXI.Text(this.notif_number, {
                    fontFamily: 'Arial',
                    fontSize: 14,
                    fill: 'yellow',
                    fontWeight: 'bold',
                    stroke: 'black',
                    strokeThickness: 4
                });
                this.notifText.anchor.set(0.5);
                this.container.addChild(this.notifText);
                this.updateNotifPosition();
            }

            this.app.stage.addChild(this.container);
            Sprite.listOfSprites.push(this);
            Sprite.#numberOfEnvironmentSprites += notif_number;
        }

        static restoreNotifactionNumberForAllSprites() {
            Sprite.#numberOfEnvironmentSprites = 0;
            this.listOfSprites.forEach(sprite => Sprite.#numberOfEnvironmentSprites += sprite.original_notif_number);
        }

        notify(newNumber) {
            if (this.showNotif && this.notifText) {
                this.notif_number = newNumber;
                this.notifText.text = newNumber;
            }
        }

        static decreaseNumberOfEnvironmentSprites() {
            Sprite.#numberOfEnvironmentSprites--;
        }

        static hasEnvironmentSprites() {
            return Sprite.#numberOfEnvironmentSprites !== 1;
        }

        static getNumberOfEnvironmentSprites() {
            return Sprite.#numberOfEnvironmentSprites;
        }


        initialize() {
            this.row = this.originalRow;
            this.col = this.originalCol;
            this.updateSizeAndPosition();
            if (this.showNotif) {
                this.updateNotifPosition();
            }
        }


        resize(gridSize) {
            if (!this.sprite) {
                console.warn("Sprite is null or not yet loaded");
                return;
            }
            if (!this.sprite || !this.container) return;
            // Update sprite size
            this._gridSize = gridSize;
            this.sprite.width = this.sprite.height = gridSize;
            // Update position
            this.sprite.x = this.col * gridSize + gridSize / 2;
            this.sprite.y = this.row * gridSize + gridSize / 2;

            // Update notification position (if applicable)
            if (this.showNotif) {
                this.notifText.x = this.sprite.x + gridSize / 3;
                this.notifText.y = this.sprite.y - gridSize / 3;
            }
            // Ensure sprite remains on the stage
            if (!this.app.stage.children.includes(this.container)) {
                this.app.stage.addChild(this.container);
            }
        }

        updateSizeAndPosition() {
            this.sprite.width = this.sprite.height = this._gridSize;
            this.sprite.x = this.col * this._gridSize + this._gridSize / 2;
            this.sprite.y = this.row * this._gridSize + this._gridSize / 2;

        }

        updateNotifPosition() {
            this.notifText.x = this.sprite.x + this._gridSize / 3;
            this.notifText.y = this.sprite.y - this._gridSize / 3;
        }

        hide() {
            this.container.visible = false;
        }

        show() {
            this.container.visible = true;
        }


    }

    class Player extends Sprite {
        static listOfPlayers = [];

        constructor(imageURL, row, col, showNotif = false, notifNumber = 0, gridSize, app, activity) {
            super(imageURL, row, col, showNotif, notifNumber, gridSize, app, activity);
            Player.listOfPlayers.push(this);
        }

        moveSmoothly(newRow, newCol, speed, isRunning, callback) {
            let targetX = newCol * this._gridSize + this._gridSize / 2;
            let targetY = newRow * this._gridSize + this._gridSize / 2;

            const animateMove = () => {
                if (!isRunning) {
                    this.sprite.x = targetX; // Snap to final position
                    this.sprite.y = targetY;
                    return;
                }
                let dx = targetX - this.sprite.x;
                let dy = targetY - this.sprite.y;

                if (Math.abs(dx) > 1 || Math.abs(dy) > 1) {
                    this.sprite.x += dx / speed;
                    this.sprite.y += dy / speed;
                    requestAnimationFrame(animateMove);
                } else {
                    this.sprite.x = targetX;
                    this.sprite.y = targetY;
                    this.row = newRow;
                    this.col = newCol;
                    if (typeof callback === "function") callback();
                }
            };

            requestAnimationFrame(animateMove);
        }

        moveSmoothlyHalfStep(newRow, newCol, speed, isRunning, callback) {
            // Adjust target position to move only 0.5 tile forward
            let currentX = this.sprite.x;
            let currentY = this.sprite.y;

            let fullTargetX = newCol * this._gridSize + this._gridSize / 2;
            let fullTargetY = newRow * this._gridSize + this._gridSize / 2;

            // Compute direction vector
            let dx = fullTargetX - currentX;
            let dy = fullTargetY - currentY;

            // Normalize direction vector
            let length = Math.sqrt(dx * dx + dy * dy);
            let unitX = dx / length;
            let unitY = dy / length;

            // Move only 0.5 grid unit in that direction
            let halfStepDistance = this._gridSize * 0.5;
            let targetX = currentX + unitX * halfStepDistance;
            let targetY = currentY + unitY * halfStepDistance;

            const animateMove = () => {
                if (!isRunning) {
                    this.sprite.x = targetX;
                    this.sprite.y = targetY;
                    return;
                }
                let dx = targetX - this.sprite.x;
                let dy = targetY - this.sprite.y;

                if (Math.abs(dx) > 1 || Math.abs(dy) > 1) {
                    this.sprite.x += dx / speed;
                    this.sprite.y += dy / speed;
                    requestAnimationFrame(animateMove);
                } else {
                    this.sprite.x = targetX;
                    this.sprite.y = targetY;
                    if (typeof callback === "function") callback();
                }
            };

            requestAnimationFrame(animateMove);
        }

        moveBy(deltaCol, deltaRow, map_layout, speed, isRunning, callback) {
            let newRow = this.row + deltaRow;
            let newCol = this.col + deltaCol;
            let rowKey = Object.keys(map_layout)[newRow];
            let colKey = Object.keys(map_layout[rowKey])[newCol];

            if (map_layout[rowKey] && map_layout[rowKey][colKey] !== undefined &&
                (map_layout[rowKey][colKey] === 1)) {
                this.moveSmoothly(newRow, newCol, speed, isRunning, callback);
            } else {
                this.moveSmoothlyHalfStep(newRow, newCol, speed, isRunning, callback);
                Activity.playSound("https://raw.githubusercontent.com/Thor1602/blockly-edu-site/main/audio/bang-crash-103775.mp3");
                this.activity.addOverlay("Crashed!!", 0xE30000)
            }
        }


        async getPerson(activity, listOfSprites, speed, callback) {
            if (!Sprite.hasEnvironmentSprites()) {
                activity.levelCompleted();
            }
            let person = listOfSprites.find(p => this.isNextTo(p));
            if (person) {
                if (person.notif_number > 1) {
                    Activity.playSound("https://raw.githubusercontent.com/Thor1602/blockly-edu-site/main/audio/pop-268648.mp3");
                    activity.giveHint("Removed 1 person", "3000");
                    await new Promise(resolve => setTimeout(resolve, speed * 100)); // 0.5 sec delay
                    Sprite.decreaseNumberOfEnvironmentSprites();
                    person.notify(person.notif_number - 1);
                } else if (person.notif_number === 1) {
                    Activity.playSound("https://raw.githubusercontent.com/Thor1602/blockly-edu-site/main/audio/pop-268648.mp3");
                    // console.log("Leftover sprites: " + Sprite.getNumberOfEnvironmentSprites());
                    activity.giveHint("Everyone is inside", "3000");
                    person.notify(person.notif_number - 1);
                    Sprite.decreaseNumberOfEnvironmentSprites();
                    person.hide();
                } else if (person.notif_number <= 0) {

                    // console.log("3 person exists, notif: " + person.notif_number);
                    activity.giveHint("No person to be picked up", "3000");
                    activity.hasFailed();
                }
                if (typeof callback === "function") await callback(person);
                return person;
            } else {
                activity.hasFailed();
                activity.giveHint("No person to be picked up", "150000");
            }

            if (typeof callback === "function") await callback(null);
            return null;
        }

        isNextTo(otherSprite) {
            if (!otherSprite) return false; // Prevent errors if null

            const dRow = Math.abs(this.row - otherSprite.row);
            const dCol = Math.abs(this.col - otherSprite.col);
            console.log(`Checking next-to: this (${this.row}, ${this.col}) vs other (${otherSprite.row}, ${otherSprite.col}) â†’ dRow: ${dRow}, dCol: ${dCol}`);

            return (dRow === 1 && dCol === 0) || (dRow === 0 && dCol === 1);
        }
    }

    $(document).ready(function () {
        $('#sidebarMenu .collapse').on('show.bs.collapse', function () {
            $('#sidebarMenu .collapse').not(this).collapse('hide');
        });

        // Change background of active dropdown
        $('#sidebarMenu .dropdown-toggle').on('click', function () {
            // Reset all dropdown backgrounds to default
            $('#sidebarMenu .nav-item').removeClass('active-bg-sidebar');
            $('#sidebarMenu .nav-item').addClass('bg-sidebar'); // Default background color

            // Apply bg-warning to the clicked (active) dropdown
            $(this).parent().removeClass('bg-sidebar').addClass('active-bg-sidebar');
        });
    });

    function toggleMenu() {
        let sidebar = document.getElementById("sidebar");
        let overlay = document.getElementById("overlay");
        sidebar.classList.toggle("show");
        overlay.classList.toggle("show");
    }


    async function init() {
        console.log("Loading next level");
        let nextLevel = sessionStorage.getItem("nextLevel");

        if (!nextLevel) {
            console.log("LOADING");
            nextLevel = "taxi_pickup_one";
            sessionStorage.setItem("nextLevel", nextLevel);
            console.log(nextLevel + " just loaded");
        }

        // Launch the activity with the actual value (without unnecessary "+ 3 already loaded")
        new Activity(nextLevel);


        buttonNextLevelElement.addEventListener("click", () => {
            // TODO add backend script to get the next level name and set it to a cookie
        });
        buttonNextLevelModalElement.addEventListener("click", () => {
            buttonNextLevelElement.disabled = true;
            $nextLevelModal.modal('hide');
        });

    }

    buttonSendBugFormElement.addEventListener("click", () => {
        try {
            google.script.run
                .withSuccessHandler(() => {
                    console.log("Report submitted successfully.");
                    $omgTeacherModal.hide();
                    Activity.giveHint("Thank you!!", "8000");
                })
                .withFailureHandler((error) => {
                    console.error("Error submitting report:", error);
                    $omgTeacherModal.hide();
                    Activity.giveHint("An error happened. Say it to me in person please.", "8000");
                })
                .sendSupportEmail("Debug Report from a Student", document.getElementById("activeUser").innerText, document.getElementById("bugContent").value);
        } catch (e) {
            console.error("Unexpected error in script.run:", e);
        }
    });


    function showPane(id) {
        document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.remove('active');
        });
        const activePane = document.getElementById(id);
        if (activePane) {
            activePane.classList.add('active');
            sessionStorage.setItem('activePane', id);
        }
        let isSidebarOpen = document.getElementById("sidebar").classList.contains("show");
        if (isSidebarOpen) {
            toggleMenu();
        }
    }

    // On page load
    window.addEventListener('DOMContentLoaded', () => {
        const sidebar = document.getElementById("sidebar");

        // Select only <a> elements where href starts with "#sequencing"
        const sequencingLinks = sidebar.querySelectorAll('a[href^="#taxiDriverSequencing"]');

        sequencingLinks.forEach(link => {
            link.addEventListener("click", function (e) {
                e.preventDefault();
                const target = link.getAttribute("href");
                console.log("Sequencing link clicked:", target);
            });
        });
        const savedPane = sessionStorage.getItem('activePane') || 'home';
        showPane(savedPane);
        gsap.from(".grade-card", {
            duration: 0.8,
            opacity: 0,
            stagger: 0.05,
            ease: "power1.out"
        });
    });
    function setNextLevel(level) {
        sessionStorage.setItem('nextLevel', level);
        showPane('codingPane');
        window.location.reload();
    }


    init();
</script>
</body>
</html>